# iOS Fastlane Configuration for WAZEET

default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    # Ensure we're in a clean state
    ensure_git_status_clean

    # Increment build number (uses agvtool)
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )

    # Get version info for commit message
    version = get_version_number(
      xcodeproj: "Runner.xcodeproj",
      target: "Runner"
    )
    build = get_build_number(xcodeproj: "Runner.xcodeproj")

    # Build the app
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.wazeet.wazeet" => "match AppStore com.wazeet.wazeet"
        }
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,  # Set to true once approved for external testing
      notify_external_testers: false,
      changelog: "Bug fixes and improvements"
    )

    # Commit version bump
    commit_version_bump(
      message: "Bump iOS version to #{version} (#{build})",
      xcodeproj: "Runner.xcodeproj"
    )

    # Tag release
    add_git_tag(
      tag: "ios-v#{version}-#{build}"
    )

    # Push to remote
    push_to_git_remote

    UI.success("✅ Successfully deployed iOS beta v#{version} (#{build}) to TestFlight!")
  end

  desc "Build iOS app for testing (no upload)"
  lane :build do
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "development"
    )
    UI.success("✅ iOS build completed")
  end

  desc "Setup code signing with match (for CI)"
  lane :setup_signing do
    match(
      type: "appstore",
      app_identifier: "com.wazeet.wazeet",
      readonly: true
    )
  end
end
