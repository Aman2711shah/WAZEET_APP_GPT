name: Build Release Artifacts

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (e.g., v1.0.0)
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  # =======================
  # Android Build
  # =======================
  build-android:
    name: ðŸ¤– Build Android Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: ðŸ“¦ Get dependencies
        run: flutter pub get
      
      - name: ðŸ” Analyze code
        run: flutter analyze --no-fatal-infos
      
      - name: ðŸ§ª Run tests
        run: flutter test
        continue-on-error: true
      
      - name: ðŸ” Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > android/key.jks
      
      - name: ðŸ“ Create key.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=wazeet
          storeFile=../key.jks
          EOF
      
      - name: ðŸ”¨ Build APK
        run: flutter build apk --release --split-per-abi
      
      - name: ðŸ“¦ Build AAB
        run: flutter build appbundle --release
      
      - name: ðŸ“Š Generate checksums
        run: |
          cd build/app/outputs/flutter-apk/
          sha256sum *.apk > checksums.txt
          cd ../bundle/release/
          sha256sum app-release.aab >> ../../../../flutter-apk/checksums.txt
      
      - name: ðŸ“¤ Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.run_number }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/flutter-apk/checksums.txt
          retention-days: 30
      
      - name: ðŸ“¤ Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ github.run_number }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 90
      
      - name: ðŸš€ Create GitHub Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/app-release.aab
          draft: true
          generate_release_notes: true

  # =======================
  # iOS Build
  # =======================
  build-ios:
    name: ðŸ Build iOS Release
    runs-on: macos-14
    timeout-minutes: 45
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: ðŸ“¦ Get dependencies
        run: flutter pub get
      
      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: ios
      
      - name: ðŸ—ï¸ Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
      
      - name: ðŸ” Install Apple Certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          # Import certificate from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
      
      - name: ðŸ“± Install Provisioning Profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles
      
      - name: ðŸ”¨ Build IPA
        run: |
          flutter build ipa --release --export-method app-store
      
      - name: ðŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ github.run_number }}
          path: build/ios/ipa/*.ipa
          retention-days: 90
      
      - name: ðŸš€ Upload to TestFlight (optional)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun altool --upload-app --type ios \
            --file "build/ios/ipa/wazeet.ipa" \
            --username "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD"
        continue-on-error: true
      
      - name: ðŸ§¹ Clean up keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

  # =======================
  # Build Report
  # =======================
  generate-report:
    name: ðŸ“Š Generate Build Report
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apk-${{ github.run_number }}
          path: artifacts/android/
        continue-on-error: true
      
      - name: ðŸ“¥ Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa-${{ github.run_number }}
          path: artifacts/ios/
        continue-on-error: true
      
      - name: ðŸ“ Generate report
        run: |
          cat > BUILD_REPORT.md << 'EOF'
          # ðŸš€ CI/CD Build Report
          
          **Workflow:** ${{ github.workflow }}  
          **Run Number:** #${{ github.run_number }}  
          **Triggered by:** ${{ github.actor }}  
          **Commit:** ${{ github.sha }}  
          **Branch/Tag:** ${{ github.ref_name }}  
          **Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ---
          
          ## ðŸ¤– Android Build
          
          **Status:** ${{ needs.build-android.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}
          
          ### Artifacts
          $(ls -lh artifacts/android/ 2>/dev/null | tail -n +2 | awk '{print "- " $9 " (" $5 ")"}' || echo "No artifacts found")
          
          ### Checksums
          \`\`\`
          $(cat artifacts/android/checksums.txt 2>/dev/null || echo "No checksums available")
          \`\`\`
          
          ---
          
          ## ðŸ iOS Build
          
          **Status:** ${{ needs.build-ios.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}
          
          ### Artifacts
          $(ls -lh artifacts/ios/ 2>/dev/null | tail -n +2 | awk '{print "- " $9 " (" $5 ")"}' || echo "No artifacts found")
          
          ---
          
          ## ðŸ“¦ Download Artifacts
          
          Visit the [Actions page](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) to download build artifacts.
          
          EOF
      
      - name: ðŸ“¤ Upload report
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ github.run_number }}
          path: BUILD_REPORT.md
          retention-days: 90
